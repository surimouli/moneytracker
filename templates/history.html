{% extends "base.html" %}
{% block content %}
<div class="mt-card">
  <!-- Header + Export -->
  <div class="mt-card-header mt-card-header-row">
    <div>
      <h2 class="mt-card-title">History</h2>
      <p class="mt-card-subtitle">
        {{ date_label }} Â·
        {% if active_category == 'all' %}
          All categories
        {% else %}
          Category <strong>{{ active_category }}</strong>
        {% endif %}
      </p>
    </div>
    <a href="{{ url_for('history.export_history_excel') }}" class="mt-secondary-btn">
      Export Excel
    </a>
  </div>

  <!-- Summary cards -->
  <div class="mt-summary-grid">
    <div class="mt-summary-card">
      <div class="mt-summary-label">Current balance</div>
      <div class="mt-summary-value {% if summary.balance < 0 %}mt-text-negative{% else %}mt-text-positive{% endif %}">
        ${{ "%.2f"|format(summary.balance) }}
      </div>
    </div>
    <div class="mt-summary-card">
      <div class="mt-summary-label">Total earned</div>
      <div class="mt-summary-value mt-text-positive">
        ${{ "%.2f"|format(summary.income) }}
      </div>
    </div>
    <div class="mt-summary-card">
      <div class="mt-summary-label">Total spent</div>
      <div class="mt-summary-value mt-text-negative">
        ${{ "%.2f"|format(summary.spending) }}
      </div>
    </div>
  </div>

  <!-- Date range chips -->
  <div class="mt-chip-row mt-chip-row-wrap">
    {% set ranges = [
      ('today', 'Today'),
      ('week', 'This Week'),
      ('month', 'This Month'),
      ('3m', 'Last 3 Months'),
      ('6m', 'Last 6 Months'),
      ('year', 'Last Year'),
      ('total', 'Total')
    ] %}
    {% for key, label in ranges %}
    <a
      href="{{ url_for('history.history_view', category=active_category, range=key) }}"
      class="mt-chip {% if date_range == key %}mt-chip-active{% endif %}"
    >
      {{ label }}
    </a>
    {% endfor %}
  </div>

  <!-- Category chips -->
  <div class="mt-chip-row mt-chip-row-scroll mb-3">
    <a
      href="{{ url_for('history.history_view', category='all', range=date_range) }}"
      class="mt-chip {% if active_category == 'all' %}mt-chip-active{% endif %}"
    >
      All
    </a>
    {% for c in categories %}
    <a
      href="{{ url_for('history.history_view', category=c.name, range=date_range) }}"
      class="mt-chip {% if active_category == c.name %}mt-chip-active{% endif %}"
    >
      {{ c.name }}
    </a>
    {% endfor %}
  </div>

  <!-- Transactions table -->
  {% if transactions %}
  <div class="table-responsive">
    <table class="table mt-table align-middle">
      <thead>
        <tr>
          <th>#</th>
          <th>Date &amp; time</th>
          <th>Category</th>
          <th>Amount</th>
          <th>Note</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for t in transactions %}
        <tr>
          <td>{{ loop.index }}</td>
          <td class="small">
            {{ t.date.strftime("%Y-%m-%d") }}<br />
            <span class="mt-muted">{{ t.date.strftime("%H:%M") }}</span>
          </td>
          <td>{{ t.category }}</td>
          <td class="{% if t.amount < 0 %}mt-text-negative{% else %}mt-text-positive{% endif %}">
            ${{ "%.2f"|format(t.amount) }}
          </td>
          <td>{{ t.note }}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-1">
              <a href="{{ url_for('history.edit_transaction', tx_id=t.id) }}" class="mt-soft-button">
                Edit
              </a>
              <form
                method="post"
                action="{{ url_for('history.delete_transaction', tx_id=t.id) }}"
                onsubmit="return confirm('Delete this transaction?');"
              >
                <button type="submit" class="mt-soft-danger-btn">
                  Delete
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="mt-empty-text mb-0">No transactions for this filter yet.</p>
  {% endif %}
</div>
{% endblock %}