{% extends "base.html" %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <!-- Top row: title + export -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="card-title mb-0">Transaction History</h5>

      <a
        href="{{ url_for('history.export_history_excel') }}"
        class="btn btn-primary btn-sm"
      >
        Export to Excel (.xlsx)
      </a>
    </div>

    <!-- Summary row -->
    <p class="text-muted mb-2">
      Showing data for: <strong>{{ date_label }}</strong>
      {% if active_category != 'all' %}
        in category <strong>{{ active_category }}</strong>
      {% else %}
        across <strong>all categories</strong>
      {% endif %}
    </p>

    <div class="row mb-4">
      <div class="col-md-4 mb-2">
        <div class="border rounded p-3 bg-light">
          <div class="text-muted small">Current Money in Account</div>
          <div class="fs-4 fw-semibold
            {% if summary.balance < 0 %}text-danger{% else %}text-success{% endif %}">
            ${{ "%.2f"|format(summary.balance) }}
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-2">
        <div class="border rounded p-3 bg-light">
          <div class="text-muted small">Total Earned</div>
          <div class="fs-4 fw-semibold text-success">
            ${{ "%.2f"|format(summary.income) }}
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-2">
        <div class="border rounded p-3 bg-light">
          <div class="text-muted small">Total Lost</div>
          <div class="fs-4 fw-semibold text-danger">
            ${{ "%.2f"|format(summary.spending) }}
          </div>
        </div>
      </div>
    </div>

    <!-- Date range filters -->
    <div class="mb-3">
      <div class="btn-group btn-group-sm" role="group" aria-label="Date range">
        {% set ranges = [
          ('today', 'Today'),
          ('week', 'This Week'),
          ('month', 'This Month'),
          ('3m', 'Last 3 Months'),
          ('6m', 'Last 6 Months'),
          ('year', 'Last Year'),
          ('total', 'Total')
        ] %}
        {% for key, label in ranges %}
        <a
          href="{{ url_for('history.history_view', category=active_category, range=key) }}"
          class="btn btn-outline-secondary {% if date_range == key %}active{% endif %}"
        >
          {{ label }}
        </a>
        {% endfor %}
      </div>
    </div>

    <!-- Category sub-tabs -->
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <a
          class="nav-link {% if active_category == 'all' %}active{% endif %}"
          href="{{ url_for('history.history_view', category='all', range=date_range) }}"
        >
          All
        </a>
      </li>
      {% for c in categories %}
      <li class="nav-item">
        <a
          class="nav-link {% if active_category == c.name %}active{% endif %}"
          href="{{ url_for('history.history_view', category=c.name, range=date_range) }}"
        >
          {{ c.name }}
        </a>
      </li>
      {% endfor %}
    </ul>

    <!-- Table -->
    {% if transactions %}
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>Date</th>
            <th>Category</th>
            <th>Amount</th>
            <th>Note</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for t in transactions %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ t.local_date.strftime("%Y-%m-%d %H:%M") }}</td>
            <td>{{ t.category }}</td>
            <td
              class="{% if t.amount < 0 %}text-danger{% else %}text-success{% endif %}"
            >
              ${{ "%.2f"|format(t.amount) }}
            </td>
            <td>{{ t.note }}</td>
            <td>
              <form
                method="post"
                action="{{ url_for('history.delete_transaction', tx_id=t.id) }}"
                onsubmit="return confirm('Delete this transaction?');"
              >
                <button class="btn btn-sm btn-outline-danger">
                  Delete
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted mb-0">No transactions for this filter.</p>
    {% endif %}
  </div>
</div>
{% endblock %}